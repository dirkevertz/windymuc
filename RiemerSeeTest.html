<!DOCTYPE html>
<html>
  <head>
    <title>Webcam Riemer See</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        margin: 0;
        /* Entferne Standard-Margins */
      }

      .container {
        display: flex;
        flex-direction: column;
        /* Bilder vertikal auf mobilen Geräten */
        position: static; /* Damit das Chart innerhalb des Containers positioniert werden kann */
        width: 100%;
      }

      .chart-container {
        position: fixed;
        bottom: 0; /* Chart am unteren Rand andocken */
        left: 0;
        width: 100%;
        height: 40%; /* Chart nimmt 1/3 der Bildhöhe ein */
        z-index: 9;
        /* Hintergrund transparent machen */
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
      }

      .chart-container canvas {
        width: 100%;
        height: auto
      }

      .image-container {
        width: 100%;
        /* Nutze die volle Bildschirmbreite */
        overflow: hidden;
        /* Verhindert, dass Bilder über den Container hinausragen */
        transform: scale(1.93);
        clip-path: polygon(20% 10%, 80% 10%, 80% 90%, 20% 90%); /* Beispiel: Ausschnitt in Form eines Trapezes */
      }

      .image {
        width: 50%;
        /* Bilder passen sich der Containerbreite an */
        height: auto;
        /* Behält das Seitenverhältnis bei */
      }

      .timestamp-container {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 3;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 5px;
        font-family: monospace;
        display: inline-block;
      }
    </style>
  </head>

  <body>
    <div class="chart-container">x
      <canvas id="myChart"></canvas>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const chartContainer = document.getElementById("myChart");

        fetch(
          "https://windyapp.co/apiV9.php?method=getMeteostationDataAndInfo&meteostationID=DWD_3379"
        )
          .then((response) => response.json())
          .then((data) => {
            const windAvg = data.response.data.map((item) => ({
              x: new Date(item.timestamp * 1000).toLocaleString(),
              y: item.wind_avg * 3.6, // m/s in km/h umrechnen
            }));
            /*
        const windMin = data.response.data.map(item => ({
            x: new Date(item.timestamp * 1000).toLocaleString(), 
            y: item.wind_min * 3.6 // m/s in km/h umrechnen
        }));*/
            const windMax = data.response.data.map((item) => ({
              x: new Date(item.timestamp * 1000).toLocaleString(),
              y: item.wind_max * 3.6, // m/s in km/h umrechnen
            }));

            new Chart(chartContainer, {
              type: "line",
              data: {
                datasets: [
                  {
                    label: "Wind Durchschnitt",
                    data: windAvg,
                    borderColor: "blue",
                    fill: false,
                  },
                  /*
              {
                label: 'Wind Minimum',
                data: windMin,
                borderColor: 'green',
                fill: false
              },*/
                  {
                    label: "Wind Maximum",
                    data: windMax,
                    borderColor: "red",
                    fill: false,
                  },
                ],
              },
              options: {
                events: ['mousemove', 'mouseout', 'click', 'touchstart', 'touchmove'],
                plugins: {
                  tooltip: {
                    // Tooltip will only receive click events
                    events: ['click']
                  }
                },
                width: window.innerWidth,
                maintainAspectRatio: false,
                responsive: true,
                scales: {
                  x: {
                    type: "category",
                  },
                  y: {
                    title: {
                      display: true,
                      text: "Windgeschwindigkeit (km/h)", // Achsenbeschriftung anpassen
                    },
                  },
                },
                onClick: function (e) {
                  const activePoints = this.getElementsAtEventForMode(
                    e,
                    "nearest",
                    { intersect: true },
                    false
                  );
                  if (activePoints.length) {
                    const firstPoint = activePoints[0];
                    const label = this.data.labels[firstPoint.index];
                    const value =
                      this.data.datasets[firstPoint.datasetIndex].data[
                        firstPoint.index
                      ];

                    // Hier wird die Funktion aufgerufen, die Datum und Uhrzeit verarbeitet
                    const regex = /(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2}):(\d{2})/;
                    const match = value.x.match(regex);

                    if (match) {
                      const [, day, month, year, hours, minutes, seconds] = match;
                      const date = new Date(year, month - 1, day, hours, minutes, seconds);
                      showData(date);
                    }
                  }
                },
              },
            });
          });
      });

      // Funktion zum Anzeigen der Daten
      function showData(date) {
        alert(date);
      }
    </script>
  </body>
</html>
