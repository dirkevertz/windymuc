<!DOCTYPE html>
<html>

<head>
  <title>Webcam Bilder</title>
  <style>
    .container {
      position: relative;
      display: flex; 
    }

    .image-container {
      display: flex;
      transform: scale(1.9);
    }

    .image {
      width: 50%;
      object-fit: cover;
    }

    .timestamp-container {
      position: absolute;
      top: 10px; 
      right: 10px;
      z-index: 1;
    }

    .timestamp {
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 5px;
      font-family: monospace;
      display: inline-block;
    }
  </style>
</head>

<body>

  <div class="container"> 
    <div class="timestamp-container">
      <div class="timestamp" id="timestamp"></div>
    </div>
    <div class="image-container"> 
      <img class="image" id="imageLeft" src="" alt="Bild links">
      <img class="image" id="imageRight" src="" alt="Bild rechts">
    </div>
  </div>

  <script>
    function createImageUrl(date, cam) {
      let dateString = date.getFullYear() + '/' + ('0' + (date.getMonth() + 1)).slice(-2) + '/' + ('0' + date.getDate()).slice(-2);
      let timeString = ('0' + date.getHours()).slice(-2) + '-' + ('0' + date.getMinutes()).slice(-2) + '-00';
      return 'https://panodata9.panomax.com/cams/2027/' + dateString + '/' + timeString + '_h2800_' + cam + '_0.jpg';
    }

    function updateImages() {
      let now = new Date();
      let minutes = Math.floor(now.getMinutes() / 10) * 10;
      now.setMinutes(minutes, 0, 0);
      timestamp = new Date(now.getTime());
      let urlLeft = createImageUrl(timestamp, 9);
      let urlRight = createImageUrl(timestamp, 10);
      loadImages(urlLeft, urlRight);
    }

    function loadImages(urlLeft, urlRight) {
      let imgLeft = new Image();
      let imgRight = new Image();

      function loadImage(img, url, cam, callback) {
        img.onload = function () {
          callback(url);
        };

        img.onerror = function () {
          console.log('Fehler beim Laden des Bildes von ' + url + '. Versuche es mit dem Bild von vor 10 Minuten.');
          timestamp = getPreviousTimestamp(timestamp);
          let newUrl = createImageUrl(timestamp, cam) + '?t=' + Date.now();
          console.log('newUrl: ' + newUrl);
          loadImage(img, newUrl, cam, callback);
        };

        img.src = url;
      }

      loadImage(imgLeft, urlLeft, 9, function (finalUrlLeft) {
        loadImage(imgRight, createImageUrl(timestamp, 10), 10, function (finalUrlRight) {
          replaceImage('imageLeft', finalUrlLeft);
          replaceImage('imageRight', finalUrlRight);
          updateTimestamp(timestamp);
        });
      });
    }

    function replaceImage(imageId, imageUrl) {
      var parentNode = document.getElementById(imageId).parentNode;
      var oldImage = document.getElementById(imageId);
      if (oldImage) {
        oldImage.parentNode.removeChild(oldImage);
      }
      var newImage = document.createElement('img');
      newImage.src = imageUrl;
      newImage.classList.add('image');
      newImage.id = imageId;
      parentNode.appendChild(newImage);
    }

    function updateTimestamp(date) {
      let dateString = date.getFullYear() + '/' + ('0' + (date.getMonth() + 1)).slice(-2) + '/' + ('0' + date.getDate()).slice(-2);
      let timeString = ('0' + date.getHours()).slice(-2) + '-' + ('0' + date.getMinutes()).slice(-2) + '-00';
      document.getElementById('timestamp').textContent = dateString + ' ' + timeString;
    }

    function getPreviousTimestamp(date) {
      let newDate = new Date(date.getTime());
      let minutes = newDate.getMinutes();
      minutes = Math.floor(minutes / 10) * 10 - 10;
      newDate.setMinutes(minutes, 0, 0);
      return newDate;
    }

    let timestamp;

    updateImages();

    setInterval(updateImages, 60000);
  </script>

</body>

</html>